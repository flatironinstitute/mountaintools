#!/usr/bin/env python

import os
import sys
import argparse
import time
from mountaintools import client as mt
import mtlogging

# @mtlogging.log(root=True)
def main():
    parser = argparse.ArgumentParser(description = 'Compute the hash of a local or remote file or directory and print the kbucket address representing a snapshot.')
    parser.add_argument('path', help='Path to local file or directory')
    parser.add_argument('--download', help='Download all remote files to the local SHA-1 cache.',action='store_true')
    parser.add_argument('--upload-to', help='Remote database to upload all files', required=False, default=None)

    args = parser.parse_args()
    path = args.path

    if mt.isFile(path):
        address = mt.saveFile(path=path)
        if not address:
            print('Unable to read or save file', file=sys.stderr)
            exit(-1)
        if args.upload_to:
            mt.login()
            mt.configRemoteReadWrite(share_id=args.upload_to)
            if not mt.saveFile(path=path):
                print('Unable to upload file', file=sys.stderr)
                exit(-1)
        print(address)
    else:
        dd = mt.readDir(path=path, recursive=True, include_sha1=True)
        if not dd:
            print('Unable to read file or directory', file=sys.stderr)
            exit(-1)
        if mt.isLocalPath(path) or args.download:
            if not _copy_files_to_local_cache(basepath=path, dd=dd):
                print('Problem copying files to local cache.')
                exit(-1)
        address = mt.saveObject(dd, basename='')
        address = address.replace('sha1://', 'sha1dir://')
        if args.upload_to:
            mt.login()
            mt.configRemoteReadWrite(share_id=args.upload_to)
            mt.saveObject(dd, basename='')
            if not _upload_files_to_share(refdir='', dd=dd):
                print('Unable to upload files to share', file=sys.stderr)
                exit(-1)
        print(address)

def _copy_files_to_local_cache(basepath, dd):
    for fname in dd['files'].keys():
        fpath = os.path.join(basepath, fname)
        if not mt.copyToLocalCache(path=fpath):
            print('Unable to copy file to local cache: '+fpath, file=sys.stderr)
            return False
    for dname, dd0 in dd['dirs'].items():
        dpath = os.path.join(basepath, dname)
        if not _copy_files_to_local_cache(basepath=dpath, dd=dd0):
            return False
    return True

def _upload_files_to_share(refdir, dd):
    for fname, file0 in dd['files'].items():
        path2 = 'sha1://'+file0['sha1']+'/'+fname
        if not mt.saveFile(path=path2):
            print('Unable upload file: '+os.path.join(refdir, fname), file=sys.stderr)
            return False
    for dname, dd0 in dd['dirs'].items():
        if not _upload_files_to_share(os.path.join(refdir, dname), dd0):
            return False
    return True

if __name__== "__main__":
    main()
  
